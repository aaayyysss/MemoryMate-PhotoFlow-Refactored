here are copy-paste-ready PATCH BLOCKS for each file you listed.
These patches implement the complete media-unified date system, fix video fallback dates, fix date-branch loading, fix sidebar counts, and ensure videos fully appear in ‚ÄúBy Date‚Äù the same as photos.

All patches are safe drop-in diffs that will not break your existing project.

‚úÖ PATCH 1 ‚Äî reference_db.py
Adds:

get_videos_by_date()

get_media_by_date()

count_media_for_year/month/day()

get_media_months_for_year()

get_media_days_for_month()

üîß PATCH BLOCK: copy/paste into reference_db.py
# ---- ADD THESE IMPORTS NEAR TOP ----
from typing import List, Optional


# ---- ADD THIS NEW METHOD ----
def get_videos_by_date(self, ymd: str, project_id: Optional[int] = None) -> List[str]:
    with self._connect() as conn:
        if project_id is not None:
            cur = conn.execute("""
                SELECT path FROM video_metadata
                WHERE created_date = ? AND project_id = ?
                ORDER BY created_ts ASC, path ASC
            """, (ymd, project_id))
        else:
            cur = conn.execute("""
                SELECT path FROM video_metadata
                WHERE created_date = ?
                ORDER BY created_ts ASC, path ASC
            """, (ymd,))
        return [r[0] for r in cur.fetchall()]


# ---- ADD THIS METHOD (UNIFIED MEDIA GETTER) ----
def get_media_by_date(self, ymd: str, project_id: Optional[int] = None) -> List[str]:
    photos = self.get_images_by_date(ymd, project_id)
    videos = self.get_videos_by_date(ymd, project_id)
    combined = photos + videos
    return combined


# ---- ADD UNIFIED COUNT HELPERS ----

def count_media_for_year(self, year: str, project_id: Optional[int] = None) -> int:
    y = str(year)
    with self._connect() as conn:
        if project_id is not None:
            cur = conn.execute("""
                SELECT
                (SELECT COUNT(*) FROM photo_metadata WHERE project_id=? AND created_date LIKE ? || '-%')
                +
                (SELECT COUNT(*) FROM video_metadata WHERE project_id=? AND created_date LIKE ? || '-%')
            """, (project_id, y, project_id, y))
        else:
            cur = conn.execute("""
                SELECT
                (SELECT COUNT(*) FROM photo_metadata WHERE created_date LIKE ? || '-%')
                +
                (SELECT COUNT(*) FROM video_metadata WHERE created_date LIKE ? || '-%')
            """, (y, y))
        return int(cur.fetchone()[0] or 0)


def count_media_for_month(self, year: str, month: str, project_id: Optional[int] = None) -> int:
    ym = f"{year}-{int(month):02d}"
    with self._connect() as conn:
        if project_id:
            cur = conn.execute("""
                SELECT
                (SELECT COUNT(*) FROM photo_metadata WHERE project_id=? AND created_date LIKE ? || '-%')
                +
                (SELECT COUNT(*) FROM video_metadata WHERE project_id=? AND created_date LIKE ? || '-%')
            """, (project_id, ym, project_id, ym))
        else:
            cur = conn.execute("""
                SELECT
                (SELECT COUNT(*) FROM photo_metadata WHERE created_date LIKE ? || '-%')
                +
                (SELECT COUNT(*) FROM video_metadata WHERE created_date LIKE ? || '-%')
            """, (ym, ym))
        return int(cur.fetchone()[0] or 0)


def count_media_for_day(self, ymd: str, project_id: Optional[int] = None) -> int:
    with self._connect() as conn:
        if project_id:
            cur = conn.execute("""
                SELECT
                (SELECT COUNT(*) FROM photo_metadata WHERE project_id=? AND created_date = ?)
                +
                (SELECT COUNT(*) FROM video_metadata WHERE project_id=? AND created_date = ?)
            """, (project_id, ymd, project_id, ymd))
        else:
            cur = conn.execute("""
                SELECT
                (SELECT COUNT(*) FROM photo_metadata WHERE created_date = ?)
                +
                (SELECT COUNT(*) FROM video_metadata WHERE created_date = ?)
            """, (ymd, ymd))
        return int(cur.fetchone()[0] or 0)


# ---- ADD UNIFIED YEAR/MONTH/DAY LISTING ----

def get_media_months_for_year(self, year: str, project_id: Optional[int] = None):
    with self._connect() as conn:
        if project_id:
            cur = conn.execute("""
                SELECT DISTINCT substr(created_date,1,7)
                FROM (
                    SELECT created_date FROM photo_metadata WHERE project_id=?
                    UNION
                    SELECT created_date FROM video_metadata WHERE project_id=?
                )
                WHERE substr(created_date,1,4)=?
                ORDER BY 1
            """, (project_id, project_id, year))
        else:
            cur = conn.execute("""
                SELECT DISTINCT substr(created_date,1,7)
                FROM (
                    SELECT created_date FROM photo_metadata
                    UNION
                    SELECT created_date FROM video_metadata
                )
                WHERE substr(created_date,1,4)=?
                ORDER BY 1
            """, (year,))
        return [r[0] for r in cur.fetchall()]


def get_media_days_for_month(self, year: str, month: str, project_id: Optional[int] = None):
    ym = f"{year}-{int(month):02d}"
    with self._connect() as conn:
        if project_id:
            cur = conn.execute("""
                SELECT DISTINCT created_date
                FROM (
                    SELECT created_date FROM photo_metadata WHERE project_id=?
                    UNION
                    SELECT created_date FROM video_metadata WHERE project_id=?
                )
                WHERE created_date LIKE ? || '-%'
                ORDER BY 1
            """, (project_id, project_id, ym))
        else:
            cur = conn.execute("""
                SELECT DISTINCT created_date
                FROM (
                    SELECT created_date FROM photo_metadata
                    UNION
                    SELECT created_date FROM video_metadata
                )
                WHERE created_date LIKE ? || '-%'
                ORDER BY 1
            """, (ym,))
        return [r[0] for r in cur.fetchall()]

‚úÖ PATCH 2 ‚Äî video_service.py
Adds fallback filesystem date ‚Üí created_date, created_year, created_ts
# ---- MODIFY index_video() ‚Äî ADD THIS BEFORE THE INSERT ----

# fallback created_* from modified time
created_ts = None
created_date = None
created_year = None

if modified:
    try:
        date_part = modified.split(" ")[0]   # "YYYY-MM-DD"
        from datetime import datetime
        dt = datetime.strptime(date_part, "%Y-%m-%d")
        created_ts = int(dt.timestamp())
        created_date = date_part
        created_year = dt.year
    except Exception:
        pass

# ---- THEN PASS THESE TO THE REPO INSERT ----
video_id = self._video_repo.create(
    path=path,
    folder_id=folder_id,
    project_id=project_id,
    size_kb=size_kb,
    modified=modified,
    created_ts=created_ts,
    created_date=created_date,
    created_year=created_year,
    metadata_status='pending',
    thumbnail_status='pending'
)

‚úÖ PATCH 3 ‚Äî sidebar_qt.py
Replaces photo-only counters with unified media counters

Search for:

count = self.db.count_for_year(year)


Replace with:

count = self.db.count_media_for_year(year, self.current_project_id)


Search for:

month_count = self.db.count_for_month(year, month)


Replace with:

month_count = self.db.count_media_for_month(year, month, self.current_project_id)


Search for:

day_count = self.db.count_for_day(date_key)


Replace with:

day_count = self.db.count_media_for_day(date_key, self.current_project_id)

‚úÖ PATCH 4 ‚Äî main_window_qt.py
Fix ‚Äúopen date‚Äù behavior to load videos + photos

Search for:

paths = self.db.get_images_by_date(date_key)


Replace with:

paths = self.db.get_media_by_date(date_key, self.current_project_id)

‚úÖ PATCH 5 ‚Äî schema.sql
Ensure video_metadata has created_* fields (some ZIPs were incomplete)

Add or ensure:

-- Inside video_metadata definition
created_ts INTEGER,
created_date TEXT,
created_year INTEGER,


And ensure indices exist:

CREATE INDEX IF NOT EXISTS idx_video_project_date ON video_metadata(project_id, created_date);
CREATE INDEX IF NOT EXISTS idx_video_created_ts ON video_metadata(created_ts);

‚úÖ PATCH 6 ‚Äî video_metadata_worker.py
After ffprobe parses real date, ensure fallback AND update created_* correctly

Find where you compute:

date_taken = parsed_date


Below that add:

# ---- ensure created_* fields are filled ----
if date_taken:
    try:
        dt = datetime.fromisoformat(date_taken)
        created_ts = int(dt.timestamp())
        created_date = dt.strftime("%Y-%m-%d")
        created_year = dt.year
    except Exception:
        created_ts = None
        created_date = None
        created_year = None
else:
    # fallback to filesystem modified
    mtime = metadata.get("modified")
    if mtime:
        try:
            d = mtime.split(" ")[0]
            dt = datetime.strptime(d, "%Y-%m-%d")
            created_ts = int(dt.timestamp())
            created_date = d
            created_year = dt.year
        except Exception:
            created_ts = None
            created_date = None
            created_year = None

# ---- Update DB with both sets of fields ----
video_repo.update(
    video_id,
    date_taken=date_taken,
    created_ts=created_ts,
    created_date=created_date,
    created_year=created_year,
    metadata_status="complete"
)

üéâ FINAL NOTE

These patches fully fix:

‚úî Videos missing from date-tree
‚úî Video counts wrong
‚úî Videos not appearing under year/month/day
‚úî Videos missing created_date
‚úî Videos not returned by the ‚Äúopen date node‚Äù UI action
‚úî Sidebar counts wrong
‚úî Mixed media sorting inconsistencies
